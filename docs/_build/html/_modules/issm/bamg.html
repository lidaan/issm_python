

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>issm.bamg &mdash; issm 4.12 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> issm
          

          
          </a>

          
            
            
              <div class="version">
                4.12
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Preliminaries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ismip_hom.html">ISMIP-HOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mismip_plus.html">MISMIP+</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/issm.html">issm package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">issm</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>issm.bamg</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for issm.bamg</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span>  <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">issm.mesh2d</span> <span class="k">import</span> <span class="n">mesh2d</span>
<span class="kn">from</span> <span class="nn">issm.pairoptions</span> <span class="k">import</span> <span class="n">pairoptions</span>
<span class="kn">from</span> <span class="nn">issm.bamggeom</span> <span class="k">import</span> <span class="n">bamggeom</span>
<span class="kn">from</span> <span class="nn">issm.bamgmesh</span> <span class="k">import</span> <span class="n">bamgmesh</span>
<span class="kn">from</span> <span class="nn">issm.expread</span> <span class="k">import</span> <span class="n">expread</span>
<span class="kn">from</span> <span class="nn">issm.expwrite</span> <span class="k">import</span> <span class="n">expwrite</span>
<span class="kn">from</span> <span class="nn">issm.SegIntersect</span> <span class="k">import</span> <span class="n">SegIntersect</span>
<span class="kn">from</span> <span class="nn">issm.BamgMesher</span> <span class="k">import</span> <span class="n">BamgMesher</span>
<span class="kn">from</span> <span class="nn">issm.ContourToNodes</span> <span class="k">import</span> <span class="n">ContourToNodes</span>
<span class="kn">import</span> <span class="nn">issm.MatlabFuncs</span> <span class="k">as</span> <span class="nn">m</span>

<div class="viewcode-block" id="bamg"><a class="viewcode-back" href="../../api/issm.html#issm.bamg.bamg">[docs]</a><span class="k">def</span> <span class="nf">bamg</span><span class="p">(</span><span class="n">md</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	BAMG - mesh generation</span>

<span class="sd">	   Available options (for more details see ISSM website http://issm.jpl.nasa.gov/):</span>

<span class="sd">	   - domain :            followed by an ARGUS file that prescribes the domain outline</span>
<span class="sd">	   - hmin :              minimum edge length (default is 10^-100)</span>
<span class="sd">	   - hmax :              maximum edge length (default is 10^100)</span>
<span class="sd">	   - hVertices :         imposed edge length for each vertex (geometry or mesh)</span>
<span class="sd">	   - hminVertices :      minimum edge length for each vertex (mesh)</span>
<span class="sd">	   - hmaxVertices :      maximum edge length for each vertex (mesh)</span>

<span class="sd">	   - anisomax :          maximum ratio between the smallest and largest edges (default is 10^30)</span>
<span class="sd">	   - coeff :             coefficient applied to the metric (2-&gt; twice as many elements, default is 1)</span>
<span class="sd">	   - cutoff :            scalar used to compute the metric when metric type 2 or 3 are applied</span>
<span class="sd">	   - err :               error used to generate the metric from a field</span>
<span class="sd">	   - errg :              geometric error (default is 0.1)</span>
<span class="sd">	   - field :             field of the model that will be used to compute the metric</span>
<span class="sd">	                         to apply several fields, use one column per field</span>
<span class="sd">	   - gradation :         maximum ratio between two adjacent edges</span>
<span class="sd">	   - Hessiantype :       0 -&gt; use double P2 projection (default)</span>
<span class="sd">	                         1 -&gt; use Green formula</span>
<span class="sd">	   - KeepVertices :      try to keep initial vertices when adaptation is done on an existing mesh (default 1)</span>
<span class="sd">	   - MaxCornerAngle :    maximum angle of corners in degree (default is 10)</span>
<span class="sd">	   - maxnbv :            maximum number of vertices used to allocate memory (default is 10^6)</span>
<span class="sd">	   - maxsubdiv :         maximum subdivision of exisiting elements (default is 10)</span>
<span class="sd">	   - metric :            matrix (numberofnodes x 3) used as a metric</span>
<span class="sd">	   - Metrictype :        1 -&gt; absolute error          c/(err coeff^2) * Abs(H)        (default)</span>
<span class="sd">	                         2 -&gt; relative error          c/(err coeff^2) * Abs(H)/max(s,cutoff*max(s))</span>
<span class="sd">	                         3 -&gt; rescaled absolute error c/(err coeff^2) * Abs(H)/(smax-smin)</span>
<span class="sd">	   - nbjacoby :          correction used by Hessiantype=1 (default is 1)</span>
<span class="sd">	   - nbsmooth :          number of metric smoothing procedure (default is 3)</span>
<span class="sd">	   - omega :             relaxation parameter of the smoothing procedure (default is 1.8)</span>
<span class="sd">	   - power :             power applied to the metric (default is 1)</span>
<span class="sd">	   - splitcorners :      split triangles whuch have 3 vertices on the outline (default is 1)</span>
<span class="sd">	   - geometricalmetric : take the geometry into account to generate the metric (default is 0)</span>
<span class="sd">	   - verbose :           level of verbosity (default is 1)</span>

<span class="sd">	   - rifts :             followed by an ARGUS file that prescribes the rifts</span>
<span class="sd">	   - toltip :            tolerance to move tip on an existing point of the domain outline</span>
<span class="sd">	   - tracks :            followed by an ARGUS file that prescribes the tracks that the mesh will stick to</span>
<span class="sd">	   - RequiredVertices :  mesh vertices that are required. [x,y,ref]; ref is optional</span>
<span class="sd">	   - tol :               if the distance between 2 points of the domain outline is less than tol, they</span>
<span class="sd">	                         will be merged</span>

<span class="sd">	   Examples:</span>
<span class="sd">	      md=bamg(md,&#39;domain&#39;,&#39;DomainOutline.exp&#39;,&#39;hmax&#39;,3000);</span>
<span class="sd">	      md=bamg(md,&#39;field&#39;,[md.inversion.vel_obs md.geometry.thickness],&#39;hmax&#39;,20000,&#39;hmin&#39;,1000);</span>
<span class="sd">	      md=bamg(md,&#39;metric&#39;,A,&#39;hmin&#39;,1000,&#39;hmax&#39;,20000,&#39;gradation&#39;,3,&#39;anisomax&#39;,1);</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1">#process options</span>
	<span class="n">options</span><span class="o">=</span><span class="n">pairoptions</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="c1">#	options=deleteduplicates(options,1);</span>

	<span class="c1">#initialize the structures required as input of Bamg</span>
	<span class="n">bamg_options</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
	<span class="n">bamg_geometry</span><span class="o">=</span><span class="n">bamggeom</span><span class="p">()</span>
	<span class="n">bamg_mesh</span><span class="o">=</span><span class="n">bamgmesh</span><span class="p">()</span>

	<span class="c1"># Bamg Geometry parameters {{{</span>
	<span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">exist</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">):</span>

		<span class="c1">#Check that file exists</span>
		<span class="n">domainfile</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">domainfile</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;bamg error message: file &#39;</span><span class="si">%s</span><span class="s2">&#39; not found&quot;</span> <span class="o">%</span> <span class="n">domainfile</span><span class="p">)</span>
		<span class="n">domain</span><span class="o">=</span><span class="n">expread</span><span class="p">(</span><span class="n">domainfile</span><span class="p">)</span>

		<span class="c1">#Build geometry </span>
		<span class="n">count</span><span class="o">=</span><span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">domaini</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>

			<span class="c1">#Check that the domain is closed</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bamg error message: all contours provided in &#39;&#39;domain&#39;&#39; should be closed&quot;</span><span class="p">)</span>

			<span class="c1">#Checks that all holes are INSIDE the principle domain outline</span>
			<span class="k">if</span> <span class="n">i</span><span class="p">:</span>
				<span class="n">flags</span><span class="o">=</span><span class="n">ContourToNodes</span><span class="p">(</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">domainfile</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flags</span><span class="p">)):</span>
					<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bamg error message: All holes should be strictly inside the principal domain&quot;</span><span class="p">)</span>

			<span class="c1">#Add all points to bamg_geometry</span>
			<span class="n">nods</span><span class="o">=</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;nods&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>    <span class="c1">#the domain are closed 0=end</span>
			<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nods</span><span class="p">],</span><span class="n">domaini</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nods</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
			<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span>   <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span><span class="mf">1.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">i</span><span class="p">:</span>
				<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">SubDomains</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">SubDomains</span><span class="p">,[</span><span class="mi">2</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

			<span class="c1"># bamg_geometry.Vertices=np.hstack((bamg_geometry.Vertices,np.vstack((domaini[&#39;x&#39;][0:nods].reshape(-1),domaini[&#39;y&#39;][0:nods].reshape(-1),np.ones((nods))))))</span>
			<span class="c1"># bamg_geometry.Edges   =np.vstack((bamg_geometry.Edges,np.hstack((np.arange(count+1,count+nods+1).reshape(-1,),np.hstack((np.arange(count+2,count+nods+1),count+1)).reshape(-1,),1.*np.ones((nods,))))))</span>
			<span class="c1"># if i:</span>
			<span class="c1"># 	bamg_geometry.SubDomains=np.vstack((bamg_geometry.SubDomains,[2,count+1,1,1]))</span>

			<span class="c1">#update counter</span>
			<span class="n">count</span><span class="o">+=</span><span class="n">nods</span>

		<span class="c1">#take care of rifts</span>
		<span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">exist</span><span class="p">(</span><span class="s1">&#39;rifts&#39;</span><span class="p">):</span>

			<span class="c1">#Check that file exists</span>
			<span class="n">riftfile</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;rifts&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">riftfile</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;bamg error message: file &#39;</span><span class="si">%s</span><span class="s2">&#39; not found&quot;</span> <span class="o">%</span> <span class="n">riftfile</span><span class="p">)</span>
			<span class="n">rift</span><span class="o">=</span><span class="n">expread</span><span class="p">(</span><span class="n">riftfile</span><span class="p">)</span>

			<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rifti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rift</span><span class="p">):</span>

				<span class="c1">#detect whether all points of the rift are inside the domain</span>
				<span class="n">flags</span><span class="o">=</span><span class="n">ContourToNodes</span><span class="p">(</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flags</span><span class="p">)):</span>
					<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;one rift has all its points outside of the domain outline&quot;</span><span class="p">)</span>

				<span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flags</span><span class="p">)):</span>
					<span class="c1">#We LOTS of work to do</span>
					<span class="nb">print</span> <span class="s2">&quot;Rift tip outside of or on the domain has been detected and is being processed...&quot;</span>

					<span class="c1">#check that only one point is outside (for now)</span>
					<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bamg error message: only one point outside of the domain is supported yet&quot;</span><span class="p">)</span>

					<span class="c1">#Move tip outside to the first position</span>
					<span class="k">if</span>   <span class="ow">not</span> <span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
						<span class="c1">#OK, first point is outside (do nothing),</span>
						<span class="k">pass</span>
					<span class="k">elif</span> <span class="ow">not</span> <span class="n">flags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
						<span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
						<span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bamg error message: only a rift tip can be outside of the domain&quot;</span><span class="p">)</span>

					<span class="c1">#Get cordinate of intersection point</span>
					<span class="n">x1</span><span class="o">=</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">y1</span><span class="o">=</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">x2</span><span class="o">=</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
					<span class="n">y2</span><span class="o">=</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
					<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
						<span class="k">if</span> <span class="n">SegIntersect</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]],[</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]])):</span>

							<span class="c1">#Get position of the two nodes of the edge in domain</span>
							<span class="n">i1</span><span class="o">=</span><span class="n">j</span>
							<span class="n">i2</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>

							<span class="c1">#rift is crossing edge [i1 i2] of the domain</span>
							<span class="c1">#Get coordinate of intersection point (http://mathworld.wolfram.com/Line-LineIntersection.html)</span>
							<span class="n">x3</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span>
							<span class="n">y3</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span>
							<span class="n">x4</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">i2</span><span class="p">]</span>
							<span class="n">y4</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">i2</span><span class="p">]</span>
<span class="c1">#							x=det([det([x1 y1; x2 y2])  x1-x2;det([x3 y3; x4 y4])  x3-x4])/det([x1-x2 y1-y2;x3-x4 y3-y4]);</span>
<span class="c1">#							y=det([det([x1 y1; x2 y2])  y1-y2;det([x3 y3; x4 y4])  y3-y4])/det([x1-x2 y1-y2;x3-x4 y3-y4]);</span>
							<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">]])),</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">],[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">],[</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span><span class="p">]])),</span><span class="n">x3</span><span class="o">-</span><span class="n">x4</span><span class="p">]]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">],[</span><span class="n">x3</span><span class="o">-</span><span class="n">x4</span><span class="p">,</span><span class="n">y3</span><span class="o">-</span><span class="n">y4</span><span class="p">]]))</span>
							<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">]])),</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">],[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">],[</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span><span class="p">]])),</span><span class="n">y3</span><span class="o">-</span><span class="n">y4</span><span class="p">]]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">],[</span><span class="n">x3</span><span class="o">-</span><span class="n">x4</span><span class="p">,</span><span class="n">y3</span><span class="o">-</span><span class="n">y4</span><span class="p">]]))</span>

							<span class="n">segdis</span><span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">x4</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y4</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
							<span class="n">tipdis</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">x4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span>

							<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tipdis</span><span class="p">)</span><span class="o">/</span><span class="n">segdis</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;toltip&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
								<span class="nb">print</span> <span class="s2">&quot;moving tip-domain intersection point&quot;</span>

								<span class="c1">#Get position of the closer point</span>
								<span class="k">if</span> <span class="n">tipdis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">tipdis</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
									<span class="n">pos</span><span class="o">=</span><span class="n">i2</span>
								<span class="k">else</span><span class="p">:</span>
									<span class="n">pos</span><span class="o">=</span><span class="n">i1</span>

								<span class="c1">#This point is only in Vertices (number pos).</span>
								<span class="c1">#OK, now we can add our own rift</span>
								<span class="n">nods</span><span class="o">=</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;nods&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
								<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="p">,</span><span class="mi">1</span><span class="p">))))))</span>
								<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">,</span>\
									<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pos</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,(</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">)]]),</span>\
									<span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))))))</span>
								<span class="n">count</span><span class="o">+=</span><span class="n">nods</span>

								<span class="k">break</span>

							<span class="k">else</span><span class="p">:</span>
								<span class="c1">#Add intersection point to Vertices</span>
								<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mi">1</span><span class="p">]])))</span>
								<span class="n">count</span><span class="o">+=</span><span class="mi">1</span>

								<span class="c1">#Decompose the crossing edge into 2 subedges</span>
								<span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">i1</span><span class="p">,</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">i2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
								<span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span><span class="p">:</span>
									<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bamg error message: a problem occurred...&quot;</span><span class="p">)</span>
								<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span>\
									<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">count</span>                     <span class="p">,</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">2</span><span class="p">]]]),</span>\
									<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">count</span>                     <span class="p">,</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">2</span><span class="p">]]]),</span>\
									<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:,:]))</span>

								<span class="c1">#OK, now we can add our own rift</span>
								<span class="n">nods</span><span class="o">=</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;nods&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
								<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="p">,</span><span class="mi">1</span><span class="p">))))))</span>
								<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">,</span>\
									<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">count</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]]),</span>\
									<span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))))))</span>
								<span class="n">count</span><span class="o">+=</span><span class="n">nods</span>

								<span class="k">break</span>

				<span class="k">else</span><span class="p">:</span>
					<span class="n">nods</span><span class="o">=</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;nods&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
					<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:],</span><span class="n">rifti</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][:],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
					<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span>   <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">i</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
					<span class="n">count</span><span class="o">=+</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span>

		<span class="c1">#Deal with tracks</span>
		<span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">exist</span><span class="p">(</span><span class="s1">&#39;tracks&#39;</span><span class="p">):</span>

			<span class="c1">#read tracks</span>
			<span class="n">track</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;tracks&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">))):</span>
				<span class="n">A</span><span class="o">=</span><span class="n">expread</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
				<span class="n">track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">A</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">track</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>    <span class="c1">#for some reason, it is of class &quot;single&quot;</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">track</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
				<span class="n">track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">track</span><span class="p">,</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">size</span><span class="p">(</span><span class="n">track</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">))))</span>

			<span class="c1">#only keep those inside</span>
			<span class="n">flags</span><span class="o">=</span><span class="n">ContourToNodes</span><span class="p">(</span><span class="n">track</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">track</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">domainfile</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">flags</span><span class="p">),:]</span>

			<span class="c1">#Add all points to bamg_geometry</span>
			<span class="n">nods</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">track</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">track</span><span class="p">))</span>
			<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span>   <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Edges</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">count</span><span class="o">+</span><span class="n">nods</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nods</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))))))</span>

			<span class="c1">#update counter</span>
			<span class="n">count</span><span class="o">+=</span><span class="n">nods</span>

		<span class="c1">#Deal with vertices that need to be kept by mesher</span>
		<span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">exist</span><span class="p">(</span><span class="s1">&#39;RequiredVertices&#39;</span><span class="p">):</span>

			<span class="c1">#recover RequiredVertices</span>
			<span class="n">requiredvertices</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;RequiredVertices&#39;</span><span class="p">)</span>    <span class="c1">#for some reason, it is of class &quot;single&quot;</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">requiredvertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
				<span class="n">requiredvertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">requiredvertices</span><span class="p">,</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">requiredvertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">))))</span>

			<span class="c1">#only keep those inside</span>
			<span class="n">flags</span><span class="o">=</span><span class="n">ContourToNodes</span><span class="p">(</span><span class="n">requiredvertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">requiredvertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">domainfile</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">requiredvertices</span><span class="o">=</span><span class="n">requiredvertices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">],:]</span>
			<span class="c1">#Add all points to bamg_geometry</span>
			<span class="n">nods</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">requiredvertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">requiredvertices</span><span class="p">))</span>

			<span class="c1">#update counter</span>
			<span class="n">count</span><span class="o">+=</span><span class="n">nods</span>

		<span class="c1">#process geom</span>
		<span class="c1">#bamg_geometry=processgeometry(bamg_geometry,options.getfieldvalue(&#39;tol&#39;,float(nan)),domain[0])</span>

	<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">:</span>
		<span class="n">bamg_geometry</span><span class="o">=</span><span class="n">bamggeom</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span> 
	<span class="k">else</span><span class="p">:</span>
		<span class="c1">#do nothing...</span>
		<span class="k">pass</span>
	<span class="c1">#}}}</span>
	<span class="c1"># Bamg Mesh parameters {{{</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">exist</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofvertices</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">strcmp</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elementtype</span><span class="p">(),</span><span class="s1">&#39;Tria&#39;</span><span class="p">):</span>

		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;mesh&#39;</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">:</span>
			<span class="n">bamg_mesh</span><span class="o">=</span><span class="n">bamgmesh</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">bamg_mesh</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofvertices</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span>
			<span class="c1">#bamg_mesh.Vertices=np.hstack((md.mesh.x.reshape(-1,),md.mesh.y.reshape(-1,),np.ones((md.mesh.numberofvertices,1))))</span>
			<span class="n">bamg_mesh</span><span class="o">.</span><span class="n">Triangles</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofelements</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>

		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">rifts</span><span class="o">.</span><span class="n">riftstruct</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;bamg error message: rifts not supported yet. Do meshprocessrift AFTER bamg&quot;</span><span class="p">)</span>
	<span class="c1">#}}}</span>
	<span class="c1"># Bamg Options {{{</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;Crack&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;Crack&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;anisomax&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;anisomax&#39;</span><span class="p">,</span><span class="mf">10.</span><span class="o">**</span><span class="mi">30</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;coeff&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;coeff&#39;</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;cutoff&#39;</span><span class="p">,</span><span class="mf">10.</span><span class="o">**-</span><span class="mi">5</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;err&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;err&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.01</span><span class="p">]]))</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;errg&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;errg&#39;</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;gradation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;gradation&#39;</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;Hessiantype&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;Hessiantype&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;hmin&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;hmin&#39;</span><span class="p">,</span><span class="mf">10.</span><span class="o">**-</span><span class="mi">100</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;hmax&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;hmax&#39;</span><span class="p">,</span><span class="mf">10.</span><span class="o">**</span><span class="mi">100</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;hminVertices&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;hminVertices&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;hmaxVertices&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;hmaxVertices&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;hVertices&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;hVertices&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;KeepVertices&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;KeepVertices&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;MaxCornerAngle&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;MaxCornerAngle&#39;</span><span class="p">,</span><span class="mf">10.</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;maxnbv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;maxnbv&#39;</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;maxsubdiv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;maxsubdiv&#39;</span><span class="p">,</span><span class="mf">10.</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;Metrictype&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;Metrictype&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;nbjacobi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;nbjacobi&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;nbsmooth&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;nbsmooth&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;omega&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span><span class="mf">1.8</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;power&#39;</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;splitcorners&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;splitcorners&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;geometricalmetric&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;geometricalmetric&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;rand&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">bamg_options</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">getfieldvalue</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="c1">#}}}</span>

	<span class="c1">#call Bamg</span>
	<span class="n">bamgmesh_out</span><span class="p">,</span><span class="n">bamggeom_out</span><span class="o">=</span><span class="n">BamgMesher</span><span class="p">(</span><span class="n">bamg_mesh</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span><span class="n">bamg_geometry</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span><span class="n">bamg_options</span><span class="p">)</span>

	<span class="c1"># plug results onto model</span>
	<span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
	<span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bamgmesh</span><span class="p">(</span><span class="n">bamgmesh_out</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bamggeom</span><span class="p">(</span><span class="n">bamggeom_out</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh2d</span><span class="p">()</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">bamgmesh_out</span><span class="p">[</span><span class="s1">&#39;Vertices&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">y</span><span class="o">=</span><span class="n">bamgmesh_out</span><span class="p">[</span><span class="s1">&#39;Vertices&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">=</span><span class="n">bamgmesh_out</span><span class="p">[</span><span class="s1">&#39;Triangles&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">edges</span><span class="o">=</span><span class="n">bamgmesh_out</span><span class="p">[</span><span class="s1">&#39;IssmEdges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">segments</span><span class="o">=</span><span class="n">bamgmesh_out</span><span class="p">[</span><span class="s1">&#39;IssmSegments&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">segmentmarkers</span><span class="o">=</span><span class="n">bamgmesh_out</span><span class="p">[</span><span class="s1">&#39;IssmSegments&#39;</span><span class="p">][:,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

	<span class="c1">#Fill in rest of fields:</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofelements</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofvertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofedges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertexonboundary</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofvertices</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertexonboundary</span><span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">segments</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elementconnectivity</span><span class="o">=</span><span class="n">md</span><span class="o">.</span><span class="n">private</span><span class="o">.</span><span class="n">bamg</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ElementConnectivity</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elementconnectivity</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elementconnectivity</span><span class="p">))]</span><span class="o">=</span><span class="mi">0</span>
	<span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elementconnectivity</span><span class="o">=</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elementconnectivity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

	<span class="c1">#Check for orphan</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numberofvertices</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">md</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">flat</span><span class="p">))):</span>
		<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Output mesh has orphans. Decrease MaxCornerAngle to prevent outside points (ex: 0.01)&quot;</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">md</span></div>

<div class="viewcode-block" id="processgeometry"><a class="viewcode-back" href="../../api/issm.html#issm.bamg.processgeometry">[docs]</a><span class="k">def</span> <span class="nf">processgeometry</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">outline</span><span class="p">):</span>    <span class="c1"># {{{</span>

	<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bamg.py/processgeometry is not complete.&quot;</span><span class="p">)</span>
	<span class="c1">#Deal with edges</span>
	<span class="nb">print</span> <span class="s2">&quot;Checking Edge crossing...&quot;</span>
	<span class="n">i</span><span class="o">=</span><span class="mi">0</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)):</span>

		<span class="c1">#edge counter</span>
		<span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

		<span class="c1">#Get coordinates</span>
		<span class="n">x1</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">y1</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">x2</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">y2</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">color1</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

		<span class="n">j</span><span class="o">=</span><span class="n">i</span>    <span class="c1">#test edges located AFTER i only</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)):</span>

			<span class="c1">#edge counter</span>
			<span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

			<span class="c1">#Skip if the two edges already have a vertex in common</span>
			<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ismember</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])):</span>
				<span class="k">continue</span>

			<span class="c1">#Get coordinates</span>
			<span class="n">x3</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">y3</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">x4</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">y4</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">color2</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

			<span class="c1">#Check if the two edges are crossing one another</span>
			<span class="k">if</span> <span class="n">SegIntersect</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">],[</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span><span class="p">]])):</span>

				<span class="c1">#Get coordinate of intersection point (http://mathworld.wolfram.com/Line-LineIntersection.html)</span>
				<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">]])),</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">],[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">],[</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span><span class="p">]])),</span><span class="n">x3</span><span class="o">-</span><span class="n">x4</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">],[</span><span class="n">x3</span><span class="o">-</span><span class="n">x4</span><span class="p">,</span><span class="n">y3</span><span class="o">-</span><span class="n">y4</span><span class="p">]])))</span>
				<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">]])),</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">],[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">],[</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span><span class="p">]])),</span><span class="n">y3</span><span class="o">-</span><span class="n">y4</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">],[</span><span class="n">x3</span><span class="o">-</span><span class="n">x4</span><span class="p">,</span><span class="n">y3</span><span class="o">-</span><span class="n">y4</span><span class="p">]])))</span>

				<span class="c1">#Add vertex to the list of vertices</span>
				<span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">color1</span><span class="p">,</span><span class="n">color2</span><span class="p">)]))</span>
				<span class="nb">id</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

				<span class="c1">#Update edges i and j</span>
				<span class="n">edgei</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="n">edgej</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>    <span class="o">=</span><span class="p">[</span><span class="n">edgei</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="nb">id</span>      <span class="p">,</span><span class="n">edgei</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
				<span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">,[</span><span class="nb">id</span>      <span class="p">,</span><span class="n">edgei</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">edgei</span><span class="p">(</span><span class="mi">2</span><span class="p">)]))</span>
				<span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span>    <span class="o">=</span><span class="p">[</span><span class="n">edgej</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="nb">id</span>      <span class="p">,</span><span class="n">edgej</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
				<span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">,[</span><span class="nb">id</span>      <span class="p">,</span><span class="n">edgej</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">edgej</span><span class="p">(</span><span class="mi">2</span><span class="p">)]))</span>

				<span class="c1">#update current edge second tip</span>
				<span class="n">x2</span><span class="o">=</span><span class="n">x</span>
				<span class="n">y2</span><span class="o">=</span><span class="n">y</span>

	<span class="c1">#Check point outside</span>
	<span class="nb">print</span> <span class="s2">&quot;Checking for points outside the domain...&quot;</span>
	<span class="n">i</span><span class="o">=</span><span class="mi">0</span>
	<span class="n">num</span><span class="o">=</span><span class="mi">0</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)):</span>

		<span class="c1">#vertex counter</span>
		<span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

		<span class="c1">#Get coordinates</span>
		<span class="n">x</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">y</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">color</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

		<span class="c1">#Check that the point is inside the domain</span>
		<span class="k">if</span> <span class="n">color</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ContourToNodes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">outline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">):</span>

			<span class="c1">#Remove points from list of Vertices</span>
			<span class="n">num</span><span class="o">+=</span><span class="mi">1</span>
			<span class="n">geom</span><span class="o">.</span><span class="n">Vertices</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="p">[]</span>

			<span class="c1">#update edges</span>
			<span class="n">posedges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="o">==</span><span class="n">i</span><span class="p">)</span>
			<span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">posedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">=</span><span class="p">[]</span>
			<span class="n">posedges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="o">&gt;</span><span class="n">i</span><span class="p">)</span>
			<span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">posedges</span><span class="p">]</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">Edges</span><span class="p">[</span><span class="n">posedges</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>

			<span class="c1">#update counter</span>
			<span class="n">i</span><span class="o">-=</span><span class="mi">1</span>

	<span class="k">if</span> <span class="n">num</span><span class="p">:</span>
		<span class="nb">print</span> <span class="s2">&quot;WARNING: </span><span class="si">%d</span><span class="s2"> points outside the domain outline have been removed&quot;</span> <span class="o">%</span> <span class="n">num</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	%Check point spacing</span>
<span class="sd">	if ~isnan(tol),</span>
<span class="sd">		disp(&#39;Checking point spacing...&#39;);</span>
<span class="sd">		i=0;</span>
<span class="sd">		while (i&lt;size(geom.Vertices,1)),</span>

<span class="sd">			%vertex counter</span>
<span class="sd">			i=i+1;</span>

<span class="sd">			%Get coordinates</span>
<span class="sd">			x1=geom.Vertices(i,1);</span>
<span class="sd">			y1=geom.Vertices(i,2);</span>

<span class="sd">			j=i; %test edges located AFTER i only</span>
<span class="sd">			while (j&lt;size(geom.Vertices,1)),</span>

<span class="sd">				%vertex counter</span>
<span class="sd">				j=j+1;</span>

<span class="sd">				%Get coordinates</span>
<span class="sd">				x2=geom.Vertices(j,1);</span>
<span class="sd">				y2=geom.Vertices(j,2);</span>

<span class="sd">				%Check whether the two vertices are too close</span>
<span class="sd">				if ((x2-x1)**2+(y2-y1)**2&lt;tol**2)</span>

<span class="sd">					%Remove points from list of Vertices</span>
<span class="sd">					geom.Vertices(j,:)=[];</span>

<span class="sd">					%update edges</span>
<span class="sd">					posedges=find(m.ismember(geom.Edges,j));</span>
<span class="sd">					geom.Edges(posedges)=i;</span>
<span class="sd">					posedges=find(geom.Edges&gt;j);</span>
<span class="sd">					geom.Edges(posedges)=geom.Edges(posedges)-1;</span>

<span class="sd">					%update counter</span>
<span class="sd">					j=j-1;</span>

<span class="sd">				end</span>
<span class="sd">			end</span>
<span class="sd">		end</span>
<span class="sd">	end</span>
<span class="sd">	%remove empty edges</span>
<span class="sd">	geom.Edges(find(geom.Edges(:,1)==geom.Edges(:,2)),:)=[];</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">geom</span></div>
<span class="c1"># }}}</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2002-2011, California Institute of Technology; 2017-2018, Evan Cummings.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'4.12',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>